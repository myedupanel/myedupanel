// File: prisma/schema.prisma

// 1. Data Source
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 2. Generator
generator client {
  provider = "prisma-client-js"
}

// ===================================
// MODELS
// ===================================

// 3. School Model
model School {
  id                String  @id @unique
  name              String  @unique
  // --- NAYE FIELDS ---
  name2             String?
  place             String?
  address           String?
  contactNumber     String?
  email             String?
  recognitionNumber String?
  udiseNo           String? @unique
  logoUrl           String?
  
  // --- YEH FIELD ZAROORI HAI ---
  genRegNo          String? 
  // --- END ---
  
  logo              String?
  session           String?
  lateFineAmount    Float?  @default(100)

  // Relations
  users             User[]
  students          Students[]
  classes           Classes[]
  teachers          Teachers[]
  templates         FeeTemplate[]
  feeRecords        FeeRecord[]
  transactions      Transaction[]
  parents           Parent[]
  attendances       Attendance[]
  exams             Exam[]
  marks             Mark[]
  assignments       Assignment[]
  todaysQuizId      Int?            @unique
  todaysQuiz        Quiz?           @relation("TodaysQuiz", fields: [todaysQuizId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  quizzes           Quiz[]          @relation("SchoolQuizLibrary")
  events            Event[]
  liveClasses       LiveClass[]
  gradingScale      GradingScale?
  studyMaterials    StudyMaterial[]
  staffAttendances  StaffAttendance[]
  // --- TIMETABLE RELATIONS ADDED ---
  timeSlots         TimeSlot[]
  workingDays       WorkingDay[]
  timetablePeriods  TimetableAssignment[]
  
  // --- FIX: Naya Staff relation add kiya ---
  staff             Staff[]
}

// 4. User Model
model User {
  id                    Int      @id @default(autoincrement())
  name                  String?
  email                 String   @unique
  password              String
  role                  String
  status                String?  @default("active")
  isVerified            Boolean  @default(false)
  
  // --- FIX: 'details' field wapas add kiya ---
  details               Json? 
  
  otp                   String?
  otpExpires            DateTime?
  resetPasswordToken    String?
  resetPasswordExpire   DateTime?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  createdById           Int?
  createdBy             User?  @relation("UserCreations", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  usersCreated          User[] @relation("UserCreations")
  staffAttendances      StaffAttendance[]
  transactions          Transaction[]
  student               Students? @relation("StudentUser")
  parent                Parent?
  // --- TIMETABLE RELATION ADDED ---
  assignedPeriods       TimetableAssignment[] @relation("TeacherAssignments")

  // --- FIX: Naya Staff Profile relation add kiya ---
  staffProfile          Staff?     @relation("StaffProfile")
}

// 5. Classes Model
model Classes {
  classid    Int      @id @default(autoincrement())
  class_name String @db.VarChar(100)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  // Relations
  students     Students[]
  feeRecords   FeeRecord[]
  transactions Transaction[]
  assignments  Assignment[]
  // --- TIMETABLE RELATION ADDED ---
  timetablePeriods TimetableAssignment[]
  
  @@unique([schoolId, class_name])
}

// 6. Students Model
model Students {
  studentid         Int       @id @default(autoincrement())
  first_name        String    @db.VarChar(100)
  father_name       String    @db.VarChar(100)
  last_name         String    @db.VarChar(100)
  guardian_contact  String    @db.VarChar(20)
  roll_number       String    @db.VarChar(20)
  dob               DateTime? @db.Date
  address           String?   @db.Text
  email             String?   @unique @db.VarChar(255)
  uid_number        String?   @db.VarChar(20)
  mother_name       String?   @db.VarChar(255)
  nationality       String?   @db.VarChar(100)
  caste             String?   @db.VarChar(100)
  birth_place       String?   @db.VarChar(255)
  previous_school   String?   @db.Text
  admission_date    DateTime? @db.Date
  progress          String?   @db.VarChar(100)
  leaving_date      DateTime? @db.Date
  leaving_reason    String?   @db.Text
  remarks           String?   @db.Text

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  userId   Int?    @unique
  user     User?   @relation("StudentUser", fields: [userId], references: [id])

  classid Int
  class   Classes @relation(fields: [classid], references: [classid])

  feeRecords   FeeRecord[]
  transactions Transaction[]
  parents      Parent[]
  attendances  Attendance[]
  marks        Mark[]
  assignments  Assignment[]
}

// 7. Teachers Model
model Teachers {
  teacher_dbid  Int     @id @default(autoincrement())
  teacherId     String  @db.VarChar(100)
  name          String  @db.VarChar(255)
  subject       String? @db.VarChar(255)
  contactNumber String? @db.VarChar(50)
  email         String  @db.VarChar(255)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  @@unique([schoolId, email])
  @@unique([schoolId, teacherId])
}

// 8. FeeTemplate Model
model FeeTemplate {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  items       Json
  totalAmount Float

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  feeRecords   FeeRecord[]
  transactions Transaction[]

  @@unique([schoolId, name])
}

// 9. FeeRecord Model
model FeeRecord {
  id         Int      @id @default(autoincrement())
  amount     Float
  discount   Float    @default(0)
  amountPaid Float    @default(0)
  balanceDue Float
  status     String
  dueDate    DateTime
  lateFine   Float    @default(0)
  isDeposit  Boolean  @default(false)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  studentId Int
  student   Students @relation(fields: [studentId], references: [studentid], onDelete: Cascade)

  classId Int
  class   Classes @relation(fields: [classId], references: [classid])

  templateId Int
  template   FeeTemplate @relation(fields: [templateId], references: [id])

  transactions Transaction[]

  @@unique([studentId, templateId, schoolId])
}

// 10. Transaction Model
model Transaction {
  id                   Int      @id @default(autoincrement())
  receiptId            String   @unique
  amountPaid           Float
  paymentDate          DateTime
  paymentMode          String
  status               String
  notes                String?
  chequeNumber         String?
  bankName             String?
  gatewayTransactionId String?
  gatewayOrderId       String?
  gatewayMethod        String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  studentId Int
  student   Students @relation(fields: [studentId], references: [studentid], onDelete: Cascade)

  classId Int
  class   Classes @relation(fields: [classId], references: [classid])

  templateId Int
  template   FeeTemplate @relation(fields: [templateId], references: [id])

  feeRecordId Int
  feeRecord   FeeRecord @relation(fields: [feeRecordId], references: [id], onDelete: Cascade) 

  collectedById Int?
  collectedBy   User? @relation(fields: [collectedById], references: [id])
}

// 11. Parent Model
model Parent {
  id            Int     @id @default(autoincrement())
  name          String
  contactNumber String
  email         String
  occupation    String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  studentId Int
  student   Students @relation(fields: [studentId], references: [studentid], onDelete: Cascade)

  userId Int?    @unique
  user   User?   @relation(fields: [userId], references: [id])

  @@unique([schoolId, email])
}

// 12. Attendance Model
model Attendance {
  id         Int      @id @default(autoincrement())
  date       DateTime @db.Date
  status     String
  notes      String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  studentId Int
  student   Students @relation(fields: [studentId], references: [studentid], onDelete: Cascade)

  @@unique([studentId, date, schoolId])
}

// 13. StaffAttendance Model
model StaffAttendance {
  id     Int      @id @default(autoincrement())
  date   DateTime @db.Date
  status String

  user     User   @relation(fields: [userId], references: [id])
  userId Int

  school   School @relation(fields: [schoolId], references: [id])
  schoolId String

  @@unique([userId, date])
}

// 14. Exam Model
model Exam {
  id             Int       @id @default(autoincrement())
  name           String
  date           DateTime? @db.Date

  className      String?
  subject        String?
  startTime      String?
  endTime        String?
  maxMarks       Float?
  minPassMarks   Float?
  examType       String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  marks Mark[]

  @@unique([schoolId, name, date])
}

// 15. Mark Model
model Mark {
  id            Int       @id @default(autoincrement())
  marksObtained Float?
  maxMarks      Float?
  percentage    Float?
  grade         String?
  subject       String?
  notes         String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  studentId Int
  student   Students @relation(fields: [studentId], references: [studentid], onDelete: Cascade)

  assessmentId Int?
  assessment   Exam? @relation(fields: [assessmentId], references: [id])

  @@unique([studentId, assessmentId, subject, schoolId])
}

// 16. Assignment Model
model Assignment {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  dueDate     DateTime?
  status      String?
  grade       String?
  subject     String?

  classInfo String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  classId Int?
  class   Classes? @relation(fields: [classId], references: [classid])

  studentId Int?
  student   Students? @relation(fields: [studentId], references: [studentid], onDelete: Cascade)

  createdAt DateTime @default(now())
}

// 17. Quiz Model
model Quiz {
  id             Int      @id @default(autoincrement())
  title          String
  questions      Json

  schoolId       String
  school         School   @relation("SchoolQuizLibrary", fields: [schoolId], references: [id])
  schoolsAsToday School[] @relation("TodaysQuiz")

  createdAt DateTime @default(now())
}

// 18. Event Model
model Event {
  id          Int      @id @default(autoincrement())
  title       String
  category    String
  date        DateTime @db.Date
  status      String
  description String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])
}

// 19. LiveClass Model
model LiveClass {
  id          Int      @id @default(autoincrement())
  topic       String
  teacherName String
  className   String
  subject     String
  date        DateTime @db.Date
  time        String
  meetingLink String
  status      String

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])
}

// 20. GradingScale Model
model GradingScale {
  id     Int    @id @default(autoincrement())
  scale  Json @default("[{\"grade\":\"A+\",\"min\":90,\"max\":100},{\"grade\":\"A\",\"min\":80,\"max\":89},{\"grade\":\"B\",\"min\":70,\"max\":79},{\"grade\":\"C\",\"min\":60,\"max\":69},{\"grade\":\"D\",\"min\":50,\"max\":59},{\"grade\":\"F\",\"min\":0,\"max\":49}]")

  schoolId String @unique
  school   School @relation(fields: [schoolId], references: [id])
}

// 21. StudyMaterial Model
model StudyMaterial {
  id               Int      @id @default(autoincrement())
  title            String
  className        String
  subject          String
  category         String
  fileUrl          String
  fileType         String
  originalFilename String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 22. TimeSlot Model
model TimeSlot {
  id             Int                   @id @default(autoincrement())
  name           String
  startTime      String
  endTime        String
  isBreak        Boolean               @default(false)

  schoolId       String
  school         School                @relation(fields: [schoolId], references: [id])

  assignments    TimetableAssignment[]

  @@unique([schoolId, name])
}

// 23. WorkingDay Model
model WorkingDay {
  id     Int    @id @default(autoincrement())
  name   String
  dayIndex   Int    @default(0)

  schoolId   String
  school     School @relation(fields: [schoolId], references: [id])

  @@unique([schoolId, name])
}

// 24. TimetableAssignment Model
model TimetableAssignment {
  id           Int      @id @default(autoincrement())
  day          String
  subject      String
  
  // Relations
  classId      Int
  class        Classes  @relation(fields: [classId], references: [classid])
  
  teacherId    Int
  teacher      User     @relation("TeacherAssignments", fields: [teacherId], references: [id])
  
  timeSlotId   Int
  timeSlot     TimeSlot @relation(fields: [timeSlotId], references: [id])
  
  schoolId     String
  school       School   @relation(fields: [schoolId], references: [id])

  // Conflict Checks
  @@unique([day, classId, timeSlotId], name: "class_time_unique")
  @@unique([day, teacherId, timeSlotId], name: "teacher_time_unique")
}

// --- FIX: Naya STAFF Model (No. 25) ---
model Staff {
  id            Int       @id @default(autoincrement())
  // --- FIX: Redundant @unique hata diya ---
  staffId       String    // Form se aayega
  contactNumber String?
  joiningDate   DateTime?
  leavingDate   DateTime?

  // School se Relation
  schoolId      String
  school        School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // User (login) se Relation
  userId        Int       @unique // One-to-one
  user          User      @relation("StaffProfile", fields: [userId], references: [id], onDelete: Cascade) // User delete toh staff profile delete

  @@unique([schoolId, staffId]) // Staff ID har school ke liye unique hona chahiye
}
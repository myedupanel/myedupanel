// File: prisma/schema.prisma

// 1. Data Source
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 2. Generator
generator client {
  provider = "prisma-client-js"
  output   = "./backend/node_modules/.prisma/client"
}

// === YAHAN NAYE ENUMS ADD KIYE GAYE HAIN (Professional Tareeka) ===
enum PlanType {
  NONE // Jinhone abhi tak koi plan nahi chuna
  TRIAL // 14-day free trial
  STARTER // Aapka paid plan
  PRO // Future ke liye
}

enum AppSubscriptionStatus {
  PENDING
  SUCCESS
  FAILED
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

// ==========================================================

// ===================================
// MODELS
// ===================================

// 3. School Model
model School {
  id                String  @id @unique
  name              String  @unique
  name2             String?
  place             String?
  address           String?
  contactNumber     String?
  email             String?
  recognitionNumber String?
  udiseNo           String? @unique
  logoUrl           String?
  genRegNo          String?
  logo              String?
  session           String?
  lateFineAmount    Float?  @default(100)

  // === YAHAN NAYE PLAN FIELDS ADD KIYE GAYE HAIN ===
  plan           PlanType  @default(TRIAL) // Naya school sign up par TRIAL plan pe rahega
  planStartDate  DateTime? // Plan kab shuru hua
  planExpiryDate DateTime? // Plan kab expire hoga
  // ===============================================

  // Relations
  users            User[]
  students         Students[]
  classes          Classes[]
  teachers         Teachers[]
  templates        FeeTemplate[]
  feeRecords       FeeRecord[]
  transactions     Transaction[]
  parents          Parent[]
  attendances      Attendance[]
  exams            Exam[]
  marks            Mark[]
  assignments      Assignment[]
  todaysQuizId     Int?
  todaysQuiz       Quiz?                 @relation("TodaysQuiz", fields: [todaysQuizId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  quizzes          Quiz[]                @relation("SchoolQuizLibrary")
  events           Event[]
  liveClasses      LiveClass[]
  gradingScale     GradingScale?
  studyMaterials   StudyMaterial[]
  staffAttendances StaffAttendance[]
  timeSlots        TimeSlot[]
  workingDays      WorkingDay[]
  timetablePeriods TimetableAssignment[]

  // === NAYE SUBSCRIPTION KI RELATION ===
  subscriptions AppSubscription[]
  // ===================================
}

// 4. User Model
model User {
  id                  Int       @id @default(autoincrement())
  name                String?
  email               String    @unique
  password            String
  role                String // Yahan "SuperAdmin" value bhi aa sakti hai
  status              String?   @default("active")
  isVerified          Boolean   @default(false)
  details             Json?
  otp                 String?
  otpExpires          DateTime?
  resetPasswordToken  String?
  resetPasswordExpire DateTime?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  createdById  Int?
  createdBy    User?  @relation("UserCreations", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  usersCreated User[] @relation("UserCreations")

  staffAttendances StaffAttendance[]
  transactions     Transaction[]
  student          Students?             @relation("StudentUser")
  parent           Parent?
  assignedPeriods  TimetableAssignment[] @relation("TeacherAssignments")

  // === NAYE SUBSCRIPTION KI RELATION ===
  appSubscriptions AppSubscription[] // Admin ne jo payments ki hain
  // ===================================

  // === INDEXING ===
  @@index([schoolId])
  @@index([createdById])
}

// 5. Classes Model
model Classes {
  classid    Int    @id @default(autoincrement())
  class_name String @db.VarChar(100)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  // Relations
  students         Students[]
  feeRecords       FeeRecord[]
  transactions     Transaction[]
  assignments      Assignment[]
  timetablePeriods TimetableAssignment[]

  @@unique([schoolId, class_name])
}

// 6. Students Model
model Students {
  studentid        Int       @id @default(autoincrement())
  first_name       String    @db.VarChar(100)
  father_name      String    @db.VarChar(100)
  last_name        String    @db.VarChar(100)
  guardian_contact String    @db.VarChar(20)
  roll_number      String    @db.VarChar(20)
  dob              DateTime? @db.Date
  address          String?   @db.Text
  email            String?   @unique @db.VarChar(255)
  uid_number       String?   @db.VarChar(20)
  mother_name      String?   @db.VarChar(255)
  nationality      String?   @db.VarChar(100)
  caste            String?   @db.VarChar(100)
  birth_place      String?   @db.VarChar(255)
  previous_school  String?   @db.Text
  admission_date   DateTime? @db.Date
  progress         String?   @db.VarChar(100)
  leaving_date     DateTime? @db.Date
  leaving_reason   String?   @db.Text
  remarks          String?   @db.Text
  dob_in_words     String?   @db.VarChar(255)

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  userId Int?  @unique
  user   User? @relation("StudentUser", fields: [userId], references: [id])

  classid Int
  class   Classes @relation(fields: [classid], references: [classid])

  feeRecords   FeeRecord[]
  transactions Transaction[]
  parents      Parent[]
  attendances  Attendance[]
  marks        Mark[]
  assignments  Assignment[]

  // === INDEXING ===
  @@index([schoolId])
  @@index([classid])
  @@index([userId])
}

// 7. Teachers Model
model Teachers {
  teacher_dbid  Int     @id @default(autoincrement())
  teacherId     String  @db.VarChar(100)
  name          String  @db.VarChar(255)
  subject       String? @db.VarChar(255)
  contactNumber String? @db.VarChar(50)
  email         String  @db.VarChar(255)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  @@unique([schoolId, email])
  @@unique([schoolId, teacherId])
}

// 8. FeeTemplate Model
model FeeTemplate {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  items       Json
  totalAmount Float

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  feeRecords   FeeRecord[]
  transactions Transaction[]

  @@unique([schoolId, name])
}

// 9. FeeRecord Model
model FeeRecord {
  id         Int      @id @default(autoincrement())
  amount     Float
  discount   Float    @default(0)
  amountPaid Float    @default(0)
  balanceDue Float
  status     String
  dueDate    DateTime
  lateFine   Float    @default(0)
  isDeposit  Boolean  @default(false)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  studentId Int
  student   Students @relation(fields: [studentId], references: [studentid], onDelete: Cascade)

  classId Int
  class   Classes @relation(fields: [classId], references: [classid])

  templateId Int
  template   FeeTemplate @relation(fields: [templateId], references: [id])

  transactions Transaction[]

  @@unique([studentId, templateId, schoolId])
  // === INDEXING ===
  @@index([schoolId])
  @@index([studentId])
  @@index([classId])
  @@index([templateId])
}

// 10. Transaction Model
model Transaction {
  id                   Int      @id @default(autoincrement())
  receiptId            String   @unique
  amountPaid           Float
  paymentDate          DateTime
  paymentMode          String
  status               String
  notes                String?
  chequeNumber         String?
  bankName             String?
  gatewayTransactionId String?
  gatewayOrderId       String?
  gatewayMethod        String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  studentId Int
  student   Students @relation(fields: [studentId], references: [studentid], onDelete: Cascade)

  classId Int
  class   Classes @relation(fields: [classId], references: [classid])

  templateId Int
  template   FeeTemplate @relation(fields: [templateId], references: [id])

  feeRecordId Int
  feeRecord   FeeRecord @relation(fields: [feeRecordId], references: [id], onDelete: Cascade)

  collectedById Int?
  collectedBy   User? @relation(fields: [collectedById], references: [id])

  // === INDEXING ===
  @@index([schoolId])
  @@index([studentId])
  @@index([feeRecordId])
  @@index([classId])
  @@index([paymentDate])
  @@index([collectedById])
}

// 11. Parent Model
model Parent {
  id            Int     @id @default(autoincrement())
  name          String
  contactNumber String
  email         String
  occupation    String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  studentId Int
  student   Students @relation(fields: [studentId], references: [studentid], onDelete: Cascade)

  userId Int?  @unique
  user   User? @relation(fields: [userId], references: [id])

  @@unique([schoolId, email])
  // === INDEXING ===
  @@index([studentId])
  @@index([userId])
}

// 12. Attendance Model
model Attendance {
  id     Int      @id @default(autoincrement())
  date   DateTime @db.Date
  status String
  notes  String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  studentId Int
  student   Students @relation(fields: [studentId], references: [studentid], onDelete: Cascade)

  @@unique([studentId, date, schoolId])
  // === INDEXING ===
  @@index([schoolId, date])
}

// 13. StaffAttendance Model
model StaffAttendance {
  id     Int      @id @default(autoincrement())
  date   DateTime @db.Date
  status String

  user   User @relation(fields: [userId], references: [id])
  userId Int

  school   School @relation(fields: [schoolId], references: [id])
  schoolId String

  @@unique([userId, date, schoolId])
  // === INDEXING ===
  @@index([schoolId, date])
}

// 14. Exam Model
model Exam {
  id           Int       @id @default(autoincrement())
  name         String
  date         DateTime? @db.Date
  className    String?
  subject      String?
  startTime    String?
  endTime      String?
  maxMarks     Float?
  minPassMarks Float?
  examType     String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  marks Mark[]

  @@unique([schoolId, name, date])
  // === INDEXING ===
  @@index([schoolId, className])
  @@index([schoolId, subject])
}

// 15. Mark Model
model Mark {
  id            Int     @id @default(autoincrement())
  marksObtained Float?
  maxMarks      Float?
  percentage    Float?
  grade         String?
  subject       String?
  notes         String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  studentId Int
  student   Students @relation(fields: [studentId], references: [studentid], onDelete: Cascade)

  assessmentId Int?
  assessment   Exam? @relation(fields: [assessmentId], references: [id])

  @@unique([studentId, assessmentId, subject, schoolId])
  // === INDEXING ===
  @@index([studentId])
  @@index([assessmentId])
}

// 16. Assignment Model
model Assignment {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  dueDate     DateTime?
  status      String?
  grade       String?
  subject     String?

  classInfo String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  classId Int?
  class   Classes? @relation(fields: [classId], references: [classid])

  studentId Int?
  student   Students? @relation(fields: [studentId], references: [studentid], onDelete: Cascade)

  createdAt DateTime @default(now())

  // === INDEXING ===
  @@index([schoolId])
  @@index([classId])
  @@index([studentId])
}

// 17. Quiz Model
model Quiz {
  id        Int    @id @default(autoincrement())
  title     String
  questions Json

  schoolId       String
  school         School   @relation("SchoolQuizLibrary", fields: [schoolId], references: [id])
  schoolsAsToday School[] @relation("TodaysQuiz")

  createdAt DateTime @default(now())

  // === INDEXING ===
  @@index([schoolId])
}

// 18. Event Model
model Event {
  id          Int      @id @default(autoincrement())
  title       String
  category    String
  date        DateTime @db.Date
  status      String
  description String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  // === INDEXING ===
  @@index([schoolId])
  @@index([schoolId, date])
}

// 19. LiveClass Model
model LiveClass {
  id          Int      @id @default(autoincrement())
  topic       String
  teacherName String
  className   String
  subject     String
  date        DateTime @db.Date
  time        String
  meetingLink String
  status      String

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  // === INDEXING ===
  @@index([schoolId])
  @@index([schoolId, date])
}

// 20. GradingScale Model
model GradingScale {
  id    Int  @id @default(autoincrement())
  scale Json @default("[{\"grade\":\"A+\",\"min\":90,\"max\":100},{\"grade\":\"A\",\"min\":80,\"max\":89},{\"grade\":\"B\",\"min\":70,\"max\":79},{\"grade\":\"C\",\"min\":60,\"max\":69},{\"grade\":\"D\",\"min\":50,\"max\":59},{\"grade\":\"F\",\"min\":0,\"max\":49}]")

  schoolId String @unique
  school   School @relation(fields: [schoolId], references: [id])
}

// 21. StudyMaterial Model
model StudyMaterial {
  id               Int     @id @default(autoincrement())
  title            String
  className        String
  subject          String
  category         String
  fileUrl          String
  fileType         String
  originalFilename String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // === INDEXING ===
  @@index([schoolId])
  @@index([schoolId, className])
  @@index([schoolId, subject])
}

// 22. TimeSlot Model
model TimeSlot {
  id        Int     @id @default(autoincrement())
  name      String
  startTime String
  endTime   String
  isBreak   Boolean @default(false)

  schoolId    String
  school      School                @relation(fields: [schoolId], references: [id])
  assignments TimetableAssignment[]

  @@unique([schoolId, name])
}

// 23. WorkingDay Model
model WorkingDay {
  id       Int    @id @default(autoincrement())
  name     String
  dayIndex Int    @default(0)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  @@unique([schoolId, name])
}

// 24. TimetableAssignment Model
model TimetableAssignment {
  id      Int    @id @default(autoincrement())
  day     String
  subject String

  // Relations
  classId Int
  class   Classes @relation(fields: [classId], references: [classid])

  teacherId Int
  teacher   User @relation("TeacherAssignments", fields: [teacherId], references: [id])

  timeSlotId Int
  timeSlot   TimeSlot @relation(fields: [timeSlotId], references: [id])

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  @@unique([day, classId, timeSlotId, schoolId], name: "class_time_unique")
  @@unique([day, teacherId, timeSlotId, schoolId], name: "teacher_time_unique")
  // === INDEXING ===
  @@index([schoolId, classId])
  @@index([schoolId, teacherId])
}

// ===================================
// === NAYE MODELS (Step 1) ADD KIYE GAYE ===
// ===================================

// 25. AppSubscription Model (Aapke platform ki payment history)
model AppSubscription {
  id             Int                   @id @default(autoincrement())
  planName       String // e.g., "STARTER"
  originalAmount Float
  finalAmount    Float // Discount ke baad
  durationInDays Int // e.g., 365
  status         AppSubscriptionStatus @default(PENDING)
  paymentId      String                @unique // Razorpay/Stripe Payment ID
  orderId        String?
  createdAt      DateTime              @default(now())

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  userId Int // Kis admin ne payment kiya
  user   User @relation(fields: [userId], references: [id])

  couponId Int?
  coupon   Coupon? @relation(fields: [couponId], references: [id])

  @@index([schoolId])
  @@index([userId])
  @@index([couponId])
}

// 26. Coupon Model (Aapka flexible coupon system)
model Coupon {
  id            Int               @id @default(autoincrement())
  code          String            @unique // e.g., "WELCOME50"
  discountType  DiscountType // "PERCENTAGE" ya "FIXED_AMOUNT"
  discountValue Float
  isActive      Boolean           @default(true)
  maxUses       Int? // null = unlimited
  timesUsed     Int               @default(0)
  expiryDate    DateTime?
  createdAt     DateTime          @default(now()) // Tracks when the coupon was created
  // Relation
  subscriptions AppSubscription[]

  @@index([code])
}

// 27. Plan Model (Plans ki details store karega)
// === YEH AAPKA UPDATED MODEL HAI ===
model Plan {
  id            String   @id @unique // "STARTER", "PLUS", "PRO"
  name          String // "Starter (The Core)"
  price         Int // 4999 (Rupees mein store karein)
  originalPrice Int? // 12999 (Optional)
  description   String
  features      Json // ["Feature 1", "Feature 2"]
  plusFeatures  Json? // (Optional) ["Feature 3", "Feature 4"]
  isPopular     Boolean  @default(false)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now()) // Plan kab bana, yeh store karega

  @@index([isActive])
}
